#!/bin/bash

MODULE_ROOT="$1"
NGX_OBJS="$2"
NGINX="$NGX_OBJS/nginx"
PIDFILE="/tmp/nginx-js.pid"
TIME=$(date +%s)

function kill_process {
	if [ -f $PIDFILE ]; then
		PID=$(cat $PIDFILE)
		kill -QUIT $PID
		sleep 1
		if [ -f $PIDFILE ]; then
			kill -KILL $PID
		fi
	fi
}

mkdir -p $MODULE_ROOT/logs

kill_process

# gdb --args
$NGINX -p $MODULE_ROOT -c nginx.conf &
sleep 1

OPTS="-i -m 10 --connect-timeout 1" # --http1.0

curl $OPTS "http://127.0.0.1:19090/run/nginx-object?prefix=$MODULE_ROOT&pid=$(cat $PIDFILE)"
curl $OPTS "http://127.0.0.1:19090/run/request-object?nginx=yes&uri=/run/request-object&method=GET"
curl $OPTS --data "some text body, ля-ля-ля" "http://127.0.0.1:19090/run/request-body?body=some+text+body,+ля-ля-ля"
curl $OPTS --http1.0 --data "@${MODULE_ROOT}request-body-file.txt" "http://127.0.0.1:19090/run/request-body-file?body=some+text+body,+ля-ля-ля"
curl $OPTS http://127.0.0.1:19090/run/file
curl $OPTS http://127.0.0.1:19090/run/process-cycle?fname=process-cycle-worker-exited-$TIME.txt
# curl $OPTS http://127.0.0.1:19090/run/timer-cascade
# curl $OPTS http://127.0.0.1:19090/run/timer-parallel
# curl $OPTS http://127.0.0.1:19090/run/cascade-tests
# curl $OPTS http://127.0.0.1:19090/run/subrequest-quick

# ab -kc 20 -n 200 http://127.0.0.1:19090/run/file


MASTER_PID=$(cat $PIDFILE)

kill_process

if [ -f "$MODULE_ROOT/process-cycle-worker-exited-$TIME.txt" ]; then
	echo "exitWorker() worked"
	rm "$MODULE_ROOT/process-cycle-worker-exited-$TIME.txt"
else
	echo "exitWorker() failed"
fi

# if [ -f "$MODULE_ROOT/process-cycle-master-exited-$MASTER_PID.txt" ]; then
# 	echo "exitMaster() worked"
# 	rm "$MODULE_ROOT/process-cycle-master-exited-$MASTER_PID.txt"
# else
# 	echo "exitMaster() failed"
# fi

echo