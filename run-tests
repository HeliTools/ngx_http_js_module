#!/bin/bash

MODULE_ROOT="$1"
NGX_OBJS="$2"
NGINX="$NGX_OBJS/nginx"
PIDFILE="/tmp/nginx-js.pid"

function kill_process {
	if [ -f $PIDFILE ]; then
		PID=$(cat $PIDFILE)
		kill -QUIT $PID
		sleep 1
		if [ -f $PIDFILE ]; then
			kill -KILL $PID
		fi
	fi
}

mkdir -p $MODULE_ROOT/logs

kill_process

# gdb --args
$NGINX -p $MODULE_ROOT -c nginx.conf &
sleep 1

OPTS="-i -m 10" # --http1.0

curl $OPTS http://127.0.0.1:19090/run/nginx-object?prefix=$MODULE_ROOT
# curl $OPTS http://127.0.0.1:19090/run/timer-order
# curl $OPTS http://127.0.0.1:19090/run/timer-cascade
# curl $OPTS http://127.0.0.1:19090/run/timer-parallel
# curl $OPTS http://127.0.0.1:19090/run/cascade-tests
# curl $OPTS http://127.0.0.1:19090/run/subrequest-quick

kill_process

echo