worker_processes  1;
debug_points abort;

pid /tmp/nginx-js.pid;
error_log logs/error.log debug_http;

events { worker_connections  1024; }

http
{
	include       /usr/local/nginx/conf/mime.types;
	default_type  text/html;
	
	js_maxmem 4M;
	# js_utf8; # do not know why but it's broken
	js_load 'js/nginx.js';
	js_require 'Handler.js';
	# js_set Nginx.someVar 123;
	
	# js_filter 'Handler.processFilter';
	# js_filter_types text/html text/css application/x-javascript;
	
	js_set $foo "function () { return 'bar' }";
	
	access_log off;
	
	sendfile        on;
	keepalive_timeout  65;
	
	server
	{
		listen       127.0.0.1:19090;
		server_name  _;
		
		root html;
		
		location /
		{
			index  index.html;
		}
		
		location /run/
		{
			js 'Handler.run';
		}
		
		location /run/request-body-file
		{
			client_body_in_file_only on;
			js 'Handler.run';
		}
		
		location = /variable-set
		{
			rewrite ^ /run/variable-set?foo=$foo? last;
		}
		
		location /quick
		{
			return 403;
		}
		
		location /slow
		{
			proxy_pass http://127.0.0.1:19090/;
			proxy_set_header Host "localhost";
		}
	}
}
